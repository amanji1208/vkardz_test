<!DOCTYPE html>
<html>
<head>
  <base href="/">
  <link rel="stylesheet" href="loader.css" />

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="The fastest way to send and receive money worldwide. Invest in bitcoin. Play games, and do a lot more.">
  <meta name="theme-color" content="#88A1AC">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="ninjapay">
  <link rel="ninjapay_live_link" href="icons/ninjapay_live_link.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="ninjapay_live_link.png" />

  <title>Ninjapay: Business & Payment Plugins</title>
  <link rel="manifest" href="/manifest.json">

  <script>
    // Register the service worker with proper error handling and logging
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/flutter_service_worker.js')
          .then(function(registration) {
            console.log('Service worker registered with scope:', registration.scope);

            // Ensure the Service Worker is ready before proceeding
            return navigator.serviceWorker.ready;
          })
          .then(function(registration) {
            console.log('Service worker is ready.');

            // Check for PushManager support
            if ('PushManager' in window) {
              console.log('PushManager is supported.');

              // Subscribe to push notifications
              return registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: 'BB5-T3jpaxFGs2ED2lvfl5hJtBynVQEiVMa4sI9S4YJf-BKwY2TUZvt6yDxhPs_nGACnIM5R3pw7A5uB7vdmoSI' // Replace with your VAPID public key
              });
            } else {
              console.error('PushManager is not supported in this browser.');
              return null;
            }
          })
          .then(function(subscription) {
            if (subscription) {
              console.log('Push subscription successful:', subscription);
            }
          })
          .catch(function(error) {
            console.error('Service worker registration or push subscription failed:', error);
          });
      });
    } else {
      console.log('Service workers are not supported in this browser.');
    }
  </script>

  <script src="flutter.js" defer></script>
</head>

<body style="background-color:#ffffff;">
<div id="loader">
  <img src="icons/ninjapay_live.svg" height="100px" width="100px" />
  <div class="lds-ellipsis">
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
</div>

<script>
  window.addEventListener('load', function(ev) {
    // Download main.dart.js and start the Flutter app
    _flutter.loader.loadEntrypoint({
      serviceWorker: {
        serviceWorkerVersion: 'flutter_service_worker.js', // Ensure this is correct
      },
      onEntrypointLoaded: function(engineInitializer) {
        engineInitializer.initializeEngine().then(function(appRunner) {
          appRunner.runApp();
        });
      }
    });
  });
</script>

<!-- ZXing Library for Barcode Scanning -->
<script src="https://unpkg.com/@zxing/library@0.19.1" type="application/javascript"></script>

<!-- Firebase Libraries -->
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
<script src="firebase_info.js"></script>
</body>
</html>
